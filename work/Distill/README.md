
# PaddleVideo
## 训练
模型训练使用的数据为原始数据，但使用一个训练好的模型对数据增加了一个标签，增加标签的方法见【数据生成】部分。目录下已有生成好的数据。
模型使用的损失函数需要用到混淆矩阵，混淆矩阵同样也是使用训好的模型得到的，生成方法见【损失函数权重生成】部分。目录下已有生成好的权重。
### 数据生成
利用自蒸馏的思想，使用一个在5折数据上训练的模型，在5个验证集上的预测结果作为第二标签，重新生成新的训练集标签
本次使用的是resnet152训练的5折模型，模型和配置文件位于resnet152_5folder目录下，生成验证集预测结果的脚本为resnet152_pred.sh，执行命令为
```bash
# 该脚本会在当前目录下生成5个验证集的预测结果文件，命名为nwc5-%d.npy，文件名称可以通过配置文件中的METRIC.val_npy指定
# 该脚本中包含5个命令，需要在脚本中分别指定gpu
sh resnet152_pred.sh
```
../../data/Distill/5fold_val_pred目录下为已生成的预测结果

使用验证集预测结果生成新的标注数据，命令如下：
```bash
# --valdata 参数为5折数据验证集的路径（其中数字1-5使用%d代替）
# --valpred 参数为模型在5折数据验证集上预测结果的路径（其中数字1-5使用%d代替）
# --output 参数为输出目录，生成train_data.npy和train_label.npy两个文件
python relabel_5fold.py
```
../../data/Distill/new_train目录下为已生成的数据

### 损失函数权重生成
同样使用数据生成中用到的模型在验证集上的结果，计算5个验证集上的混淆矩阵，根据混淆矩阵生成代价敏感矩阵
执行以下命令
```bash
# --valpred 参数为模型在5折数据验证集上预测结果的路径（其中数字1-5使用%d代替）
# --output 参数为输出目录,生成cm_cost.npy
python gen_cm_cost.py
```
./data/cm_cost.npy为已生成好的代价矩阵


### 执行训练
训练需要的数据路径及相关配置都在configs目录下的yaml中，默认使用的是我们之前生成的，如需修改需要对配置文件进行修改
```bash
# 参数为输出日志目录，不存在会创建，已存在会覆盖
sh train.sh
```

## 快速测试
在model_for_test目录下，是我们之前训好的模型，可以进行快速测试
如果要使用新的训练好的模型，需要修改test.sh脚本中的模型路径
```bash
# 参数为测试集路径
sh test.sh
```

