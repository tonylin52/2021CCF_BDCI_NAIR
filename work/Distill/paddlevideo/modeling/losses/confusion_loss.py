import paddle
import paddle.nn as nn
import paddle.nn.functional as F
# from paddle.autograd import Variable
from ..registry import LOSSES
import numpy as np


@LOSSES.register()
class ConfusionLoss(nn.Layer):

    def __init__(self, class_num=30, alpha=1,
                 confusion_file = "/aiot_nfs/zhaohe/PaddleCompete/data_process/cm_cost.npy"):
        super(ConfusionLoss, self).__init__()
        self.alpha = alpha
        print("confusion loss alpha: %f"%self.alpha)
        self.class_num = class_num
       #  self.confusin_cost = [[  0.        ,   0.        ,   0.3794008 ,   0.        ,
       #    2.22897969,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.88075185,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.1897004 ,
       #    0.        ,   0.        ,   0.        ,  12.89962712,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,  33.89125036,
       #    0.        , 172.62736297,   0.        ,  60.75155274,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   2.84550598,   0.8062267 ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   9.95927094,   0.1897004 ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   1.61245339],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,  15.12333735,   0.        ,
       #   17.92668769,   0.        ,   0.        ,   0.        ,
       #    0.        ,   2.84550598,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.90107689,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    2.64225556,  48.17507804,   0.        ,   0.        ,
       #    0.        , 140.65286153,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   1.42275299,   0.        ,   4.97963547,
       #    0.        ,   0.        ,   0.94850199,   3.39696063,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #   76.19114381,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #   39.69480846,   0.        ,   0.        ,   0.        ,
       #    0.        ,   4.26825897,   0.        ,  14.93890641,
       #    0.88075185,   0.        ,   0.        ,   3.39696063,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.94850199,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        , 125.20226325,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,  49.3221037 ,   0.        ,  14.46465541,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   1.89700399,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   6.0071793 ,
       #    0.        ,   0.        ,  40.32889961,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,  12.80477692,   5.73412569,   4.97963547,
       #    0.88075185,   0.        ,   0.        ,   5.09544095,
       #    0.        ,   0.        ,   1.65987849,   0.1897004 ,
       #    6.02188475,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        , 131.46237641,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,  11.29708345,
       #    0.        ,   0.        ,   0.        , 124.39603656,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,  16.1245339 ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    1.28047769,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   4.97963547,
       #    0.        ,   0.        ,  41.73408775,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,  13.27902792,   0.94850199,   0.8062267 ,
       #    0.        ,   0.        ],
       # [  0.        ,  59.47107504,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        , 147.96631111,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,  11.38202393,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,  30.64391059,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,  12.33052593,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   6.63951396,   0.        ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.94850199,   0.        ,   0.        ,   0.        ,
       #    8.91591875,   6.30753826,   0.        ,   0.        ,
       #   10.24382154,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   5.73412569,   4.97963547,
       #    0.88075185,   0.        ,   0.        ,   0.        ,
       #    0.        ,   4.01865319,   0.        ,   0.        ,
       #   30.10942377,   0.        ,   0.        ,   0.        ,
       #    5.44222456,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #   17.83183749,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   2.89293108,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.88075185,   6.02188475,   0.        ,   0.        ,
       #    0.        ,  32.14922549,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.94850199,   0.        ,   0.        ,   0.        ,
       #    0.        ,   3.60430758,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,  61.14529135,
       #    0.        ,   0.        ,   1.65987849,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    4.45795937,   0.90107689,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.94850199,   0.        ,
       #   36.92217519,   8.03730637,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.94850199,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #   35.66367499,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   5.73412569,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,  88.4103701 ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   6.0071793 ,
       #    0.        ,   0.90107689,   0.        ,   0.        ,
       #    0.        ,   0.        ,  71.50245803,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   1.69848032,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,  13.27902792,   0.94850199,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   2.70323068,   0.        ,   0.        ,
       #    5.12191077,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,  64.73526111,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.94850199,   0.        ,
       #    5.44222456,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    1.28047769,   0.        ,   0.        ,   0.        ,
       #    0.        ,   1.42275299,   0.        ,   0.        ,
       #   31.70706667,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #  129.28082183,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   1.42275299,   5.73412569,   0.        ,
       #    0.88075185,  42.15319328,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.94850199,   0.        ,
       #    0.        ,   0.        ],
       # [  1.89700399,   0.        ,   0.7588016 ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.94850199,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.3794008 ,
       #    0.        ,   0.        ,   0.        ,   0.8062267 ,
       #    0.        ,  43.53624154],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   3.31975698,   0.        ,
       #    0.        ,   0.        ,   1.89700399,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   3.60430758,   0.        ,   0.        ,
       #    5.12191077,   0.        ,   0.        ,   0.        ,
       #    0.        ,  41.25983675,   0.        ,   0.        ,
       #    0.88075185,   0.        ,   0.        ,   0.        ,
       #    6.15369587,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   4.93221037,  35.75122902,   0.        ,
       #    6.32334663,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,  19.91854188,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,  15.65028291,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    2.56095538,  14.79663111,   0.        ,  14.46465541,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   1.65987849,   0.1897004 ,
       #    0.        ,   0.        ,   0.        ,   0.8062267 ,
       #    0.        ,   3.22490678],
       # [ 15.17603191,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.90107689,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ],
       # [  0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,  40.54846026,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.94850199,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    6.02188475,   0.        ,   1.89700399,   0.        ,
       #    0.        ,   1.61245339],
       # [  0.        ,   3.13005658,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    1.28047769,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,   0.        ,   0.        ,
       #    0.        ,   0.        ,  51.45623319,   0.        ,
       #    0.        ,   0.        ,   0.94850199,   0.        ,
       #    0.        ,   0.        ]]# 30x30

        # self.confusin_cost = np.array(self.confusin_cost)
        self.confusin_cost = np.load(confusion_file)
        self.confusin_cost = 1/(1+np.exp(-self.confusin_cost))
        # self.confusin_cost = self.confusin_cost /100


    def forward(self, inputs, targets, valid_mode, soft_label=True):
        if valid_mode:
            return 0.0

        P = F.softmax(inputs, axis=1)

        label = paddle.argmax(targets, axis=1, dtype='int32')
        pred =  paddle.argmax(P, axis=1, dtype='int32')
        # print(label)
        # print(pred)
        # print(self.confusin_cost.shape)
        weight = paddle.to_tensor(self.confusin_cost[label.numpy().tolist(),pred.numpy().tolist()])
        # print(weight)



        cross_entropy = targets * paddle.log(P)
        cross_entropy = -1.0 * paddle.fluid.layers.reduce_sum(cross_entropy, dim=-1)
        # print(weight*cross_entropy)
        cross_entropy = paddle.mean((weight+self.alpha)*cross_entropy)

        return cross_entropy

